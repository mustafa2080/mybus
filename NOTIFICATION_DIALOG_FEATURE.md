# ميزة Dialog الإشعارات التفاعلية

## نظرة عامة

تم إضافة ميزة جديدة لعرض dialog تفاعلي عندما يصل الإشعار للمستخدم المطلوب، مما يضمن لفت انتباه المستخدم للإشعار المهم.

## الملفات الجديدة

### 1. `lib/services/notification_dialog_service.dart`
خدمة متخصصة لعرض dialog الإشعارات التفاعلية مع الميزات التالية:
- تصميم جذاب مع تدرجات لونية
- أيقونات مخصصة حسب نوع الإشعار
- تأثيرات بصرية (نبضة، ظلال)
- إغلاق تلقائي بعد 8 ثوان
- أزرار إجراءات تفاعلية
- اهتزاز للفت الانتباه

### 2. `notification_dialog_setup_example.dart`
مثال شامل على كيفية الإعداد والاستخدام مع شاشة اختبار تفاعلية.

### 3. `NOTIFICATION_DIALOG_FEATURE.md`
دليل شامل للميزة الجديدة.

## الميزات الرئيسية

### 1. تصميم جذاب ومتجاوب
- **تدرجات لونية**: ألوان مختلفة حسب نوع الإشعار
- **أيقونات مخصصة**: أيقونة مناسبة لكل نوع إشعار
- **تأثيرات بصرية**: نبضة للأيقونة وظلال متحركة
- **تصميم متجاوب**: يتكيف مع أحجام الشاشات المختلفة

### 2. تفاعل محسن
- **اهتزاز**: تنبيه لمسي عند ظهور الإشعار
- **إغلاق تلقائي**: يختفي بعد 8 ثوان تلقائياً
- **أزرار تفاعلية**: إغلاق أو عرض التفاصيل
- **إجراءات مخصصة**: حسب نوع الإشعار

### 3. أنواع الإشعارات المدعومة

#### إشعارات الطلاب (أخضر)
- **النوع**: `student`, `boarding`, `arrival`
- **الأيقونة**: 🚌 باص، 🏠 منزل
- **الإجراءات**: عرض تفاصيل الطالب

#### إشعارات الغياب (أحمر)
- **النوع**: `absence`, `emergency`
- **الأيقونة**: ⚠️ تحذير، 📅 تقويم
- **الإجراءات**: عرض تفاصيل الغياب

#### إشعارات الترحيب (أزرق)
- **النوع**: `welcome`, `tutorial`
- **الأيقونة**: 🎉 احتفال، 🎓 مدرسة
- **الإجراءات**: عرض الدليل التعليمي

#### إشعارات إدارية (برتقالي)
- **النوع**: `admin`, `assignment`
- **الأيقونة**: ⚙️ إعدادات، 📋 تكليف
- **الإجراءات**: عرض تفاصيل التكليف

#### إشعارات الدعم (بنفسجي)
- **النوع**: `support`
- **الأيقونة**: 🆘 دعم
- **الإجراءات**: عرض معلومات الدعم

## التكامل مع النظام الموجود

### 1. تحديث خدمة الإشعارات الرئيسية
```dart
// في notification_service.dart
if (targetUserId != null && currentUser?.uid == targetUserId) {
  // عرض الإشعار العادي
  _showSystemNotification(message, targetUserId);
  
  // عرض dialog تفاعلي للفت الانتباه
  NotificationDialogService().showNotificationDialog(message);
}
```

### 2. إعداد مفتاح التنقل في main.dart
```dart
class MyApp extends StatelessWidget {
  static final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      navigatorKey: navigatorKey,
      builder: (context, child) {
        NotificationDialogService.setNavigatorKey(navigatorKey);
        return child!;
      },
      // باقي الإعدادات...
    );
  }
}
```

## كيفية عمل النظام

### 1. استقبال الإشعار
```
إشعار FCM → التحقق من المستخدم المستهدف → عرض الإشعار العادي + Dialog تفاعلي
```

### 2. عرض Dialog
```
تشغيل اهتزاز → عرض Dialog مع تأثيرات بصرية → إغلاق تلقائي بعد 8 ثوان
```

### 3. تفاعل المستخدم
```
المستخدم يضغط "إغلاق" → إغلاق فوري
المستخدم يضغط "عرض التفاصيل" → إغلاق Dialog + عرض تفاصيل مخصصة
```

## الاختبار

### شاشة الاختبار التفاعلية
```dart
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => NotificationDialogTestScreen(),
  ),
);
```

### اختبار سريع
```dart
// إنشاء إشعار وهمي للاختبار
final fakeMessage = FakeRemoteMessage(
  notification: FakeNotification(
    title: 'ركب أحمد الباص',
    body: 'ركب الطالب أحمد محمد الباص في الساعة 7:30 صباحاً',
  ),
  data: {
    'type': 'student',
    'studentName': 'أحمد محمد',
    'busRoute': 'الخط الأول',
    'action': 'view_student',
  },
);

// عرض Dialog
NotificationDialogService().showNotificationDialog(fakeMessage);
```

## التخصيص

### 1. تخصيص الألوان
```dart
Color _getNotificationColor(String type) {
  switch (type.toLowerCase()) {
    case 'student':
      return Color(0xFF10B981); // أخضر مخصص
    case 'emergency':
      return Color(0xFFEF4444); // أحمر مخصص
    // إضافة المزيد من الألوان...
  }
}
```

### 2. تخصيص الأيقونات
```dart
IconData _getNotificationIcon(String type) {
  switch (type.toLowerCase()) {
    case 'student':
      return Icons.directions_bus; // أيقونة مخصصة
    // إضافة المزيد من الأيقونات...
  }
}
```

### 3. تخصيص مدة العرض
```dart
// تغيير مدة الإغلاق التلقائي من 8 ثوان
Future.delayed(Duration(seconds: 10), () {
  // إغلاق Dialog
});
```

## الفوائد للمستخدمين

### للمشرفين:
- ✅ **تنبيه فوري** عند ركوب/نزول الطلاب
- ✅ **لفت انتباه بصري** مع الألوان والتأثيرات
- ✅ **تفاعل سريع** مع أزرار الإجراءات
- ✅ **معلومات واضحة** في تصميم جذاب

### لأولياء الأمور:
- ✅ **تنبيه فوري** عن حالة أطفالهم
- ✅ **تصميم واضح** وسهل الفهم
- ✅ **إجراءات سريعة** لعرض التفاصيل
- ✅ **راحة بال** مع التنبيهات الواضحة

### للإدمن:
- ✅ **تنبيهات إدارية** واضحة ومميزة
- ✅ **إجراءات سريعة** للمهام الإدارية
- ✅ **تنظيم أفضل** للإشعارات حسب النوع

## أفضل الممارسات

1. **تأكد من إعداد مفتاح التنقل** في main.dart
2. **اختبر جميع أنواع الإشعارات** قبل النشر
3. **خصص الألوان والأيقونات** حسب هوية التطبيق
4. **راقب أداء Dialog** وتأثيره على تجربة المستخدم
5. **استخدم الاهتزاز بحذر** لتجنب الإزعاج

## المشاكل المحتملة والحلول

### المشكلة: Dialog لا يظهر
**الحل**: تأكد من إعداد مفتاح التنقل بشكل صحيح

### المشكلة: Dialog يظهر للمستخدم الخطأ
**الحل**: تأكد من التحقق من `targetUserId` قبل العرض

### المشكلة: تأثير على الأداء
**الحل**: قلل من التأثيرات البصرية أو مدة العرض

## الخلاصة

ميزة Dialog الإشعارات التفاعلية تحسن تجربة المستخدم بشكل كبير من خلال:
- 🎯 **لفت الانتباه الفعال** للإشعارات المهمة
- 🎨 **تصميم جذاب ومتجاوب** يناسب جميع أنواع الإشعارات
- ⚡ **تفاعل سريع** مع إجراءات مخصصة
- 🔧 **سهولة التخصيص** والتكامل مع النظام الموجود
- 📱 **تجربة مستخدم محسنة** مع تنبيهات واضحة وفعالة
