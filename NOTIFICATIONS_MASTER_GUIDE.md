# دليل نظام الإشعارات الشامل - MyBus App

## 📋 نظرة عامة

هذا الدليل الموحد يحتوي على جميع المعلومات المتعلقة بنظام الإشعارات في تطبيق MyBus، بدلاً من الملفات المتعددة والمتكررة.

## 🎯 المميزات الرئيسية

### ✅ الإشعارات المحققة
- **صوت واهتزاز** مع كل إشعار
- **ظهور في شريط الإشعارات** حتى لو كان التطبيق مغلق
- **إشعارات فورية** لجميع الأحداث المهمة
- **قنوات منظمة** حسب نوع الإشعار
- **استبعاد الإدمن** من إشعارات العمليات التي يقوم بها

## 🏗️ البنية التقنية

### الخدمات الرئيسية
```
lib/services/
├── enhanced_notification_service.dart  # الخدمة المحسنة
├── notification_service.dart           # الخدمة الأساسية
├── fcm_service.dart                    # خدمة FCM
└── fcm_background_handler.dart         # معالج الخلفية
```

### قنوات الإشعارات
- `mybus_notifications` - الإشعارات العامة
- `student_notifications` - إشعارات الطلاب
- `bus_notifications` - إشعارات الباص
- `absence_notifications` - إشعارات الغياب
- `admin_notifications` - إشعارات الإدارة
- `emergency_notifications` - إشعارات الطوارئ

## 📱 أنواع الإشعارات

### 1. إشعارات الطلاب 👨‍🎓
- **تسكين الطالب**: إشعار لولي الأمر والمشرف والإدارة
- **إلغاء التسكين**: إشعار عند إزالة الطالب من الباص
- **تحديث البيانات**: إشعار عند تعديل معلومات الطالب

### 2. إشعارات الباص 🚌
- **ركوب الطالب**: إشعار فوري لولي الأمر عند ركوب الباص
- **نزول الطالب**: إشعار عند وصول الطالب للمدرسة/المنزل

### 3. إشعارات الغياب 📝
- **طلب غياب جديد**: إشعار للمشرف والإدارة
- **موافقة على الغياب**: إشعار لولي الأمر
- **رفض الغياب**: إشعار لولي الأمر مع السبب

### 4. إشعارات الشكاوى 📢
- **شكوى جديدة**: إشعار للإدارة
- **رد على الشكوى**: إشعار لولي الأمر

### 5. إشعارات الطوارئ 🚨
- **حالات الطوارئ**: إشعارات عالية الأولوية
- **تحديث حالة الرحلة**: إشعارات تأخير أو تغيير المسار

## 🔧 الإعداد والتشغيل

### 1. تحديث Dependencies
```yaml
dependencies:
  flutter_local_notifications: ^17.2.2
  firebase_messaging: ^14.9.4
  audioplayers: ^6.0.0
  vibration: ^1.8.4
  uuid: ^4.4.0
```

### 2. تشغيل التطبيق
```bash
flutter pub get
flutter run
```

### 3. اختبار النظام
- انتقل إلى: `/test/notification-system`
- اختبر جميع أنواع الإشعارات
- تحقق من الصوت والاهتزاز والظهور في شريط الإشعارات

## 🛠️ الميزات المحسنة

### استبعاد الإدمن من الإشعارات الذاتية
```dart
// مثال: عند تسكين طالب
await NotificationService().notifyStudentAssignmentWithSound(
  studentId: student.id,
  studentName: student.name,
  busId: busId,
  parentId: student.parentId,
  supervisorId: supervisorId,
  excludeAdminId: currentUser?.uid, // استبعاد الإدمن الحالي
);
```

### إشعارات FCM للخلفية
```dart
@pragma('vm:entry-point')
Future<void> firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp();
  await _showBackgroundNotification(message);
}
```

## 📱 إعدادات المنصات

### Android (AndroidManifest.xml)
```xml
<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
<uses-permission android:name="android.permission.VIBRATE" />

<meta-data
    android:name="com.google.firebase.messaging.default_notification_channel_id"
    android:value="mybus_notifications" />
```

### iOS (Info.plist)
```xml
<key>UIBackgroundModes</key>
<array>
    <string>remote-notification</string>
</array>
```

## 🧪 الاختبار

### شاشة الاختبار
- **المسار**: `/test/notification-system`
- **الميزات**: اختبار جميع أنواع الإشعارات
- **التحقق**: الصوت، الاهتزاز، الظهور في الشريط

### اختبار يدوي
1. تسكين طالب → تحقق من إشعار ولي الأمر والمشرف
2. ركوب/نزول طالب → تحقق من إشعار ولي الأمر
3. طلب غياب → تحقق من إشعار المشرف
4. شكوى → تحقق من إشعار الإدارة

## 🔍 استكشاف الأخطاء

### الإشعارات لا تظهر
1. تحقق من أذونات التطبيق
2. تأكد من تفعيل الإشعارات في إعدادات الهاتف
3. تحقق من اتصال الإنترنت
4. أعد تشغيل التطبيق

### لا يوجد صوت
1. تحقق من عدم تفعيل الوضع الصامت
2. تأكد من وجود ملف `notification_sound.mp3`
3. تحقق من إعدادات قناة الإشعارات

### الإشعارات متأخرة
1. تحقق من إعدادات توفير البطارية
2. أضف التطبيق للتطبيقات المستثناة
3. تحقق من قوة الإنترنت

## 📊 الإحصائيات والمراقبة

### ما يتم تتبعه
- عدد الإشعارات المرسلة
- معدل قراءة الإشعارات
- أنواع الإشعارات الأكثر استخداماً
- أوقات الذروة

### السجلات
- سجل مفصل في وحدة التحكم
- معالجة الأخطاء المتقدمة
- تتبع حالة الإرسال

## 🎯 النتيجة النهائية

النظام يوفر:
- ✅ **إشعارات احترافية** تظهر في شريط الإشعارات
- ✅ **صوت واهتزاز** مع كل إشعار
- ✅ **تنظيم ذكي** للإشعارات حسب النوع
- ✅ **استبعاد الإشعارات الذاتية** للإدمن
- ✅ **عمل في جميع حالات التطبيق** (مفتوح/خلفية/مغلق)
- ✅ **اختبار شامل** لضمان الجودة

---

**ملاحظة**: هذا الدليل يحل محل جميع ملفات الإشعارات المتكررة ويوفر مرجع موحد شامل.
